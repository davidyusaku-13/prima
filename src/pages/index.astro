---
import Layout from "../layouts/Layout.astro";
import { SignedIn, SignedOut } from "@clerk/astro/components";

const apiUrl = import.meta.env.API_URL ?? "http://localhost:8080";

const health = await fetch(`${apiUrl}/health`)
  .then((r) => r.json())
  .catch(() => ({ status: "down", db: "down" }));

const users = await fetch(`${apiUrl}/users`)
  .then((r) => (r.ok ? r.json() : []))
  .catch(() => []);
---

<Layout title="Clerk + Astro + PostgreSQL">
  <SignedOut>
    <p>Sign in to try Clerk out!</p>
  </SignedOut>

  <SignedIn>
    <p>You are signed in!</p>
    <p>Backend health: {health.status}</p>
    <p>DB health: {health.db}</p>

    <h3>Users</h3>
    <ul>
      {
        users.map(
          (u: {
            id: number;
            name: string;
            email?: string;
            username?: string;
          }) => (
            <li>
              {u.id} - {u.name}
              {u.username ? ` (@${u.username})` : ""}
              {u.email ? ` (${u.email})` : ""}
            </li>
          ),
        )
      }
    </ul>
  </SignedIn>
</Layout>
